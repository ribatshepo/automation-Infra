# Redis Configuration File
# Generated by Ansible - {{ ansible_date_time.iso8601 }}

################################## NETWORK #####################################

# Bind to specific network interfaces
bind {{ redis_bind_address | default('127.0.0.1') }}

# Accept connections on the specified port
port {{ redis_port | default(6379) }}

# TCP listen() backlog
tcp-backlog {{ redis_tcp_backlog | default(511) }}

# TCP keepalive
tcp-keepalive {{ redis_tcp_keepalive | default(300) }}

# Timeout for idle clients (0 = never timeout)
timeout {{ redis_timeout | default(0) }}

################################# TLS/SSL ######################################

# Enable TLS/SSL support
{% if redis_tls_enabled | default(false) %}
tls-port {{ redis_tls_port | default(6380) }}
port 0

# Configure certificates
tls-cert-file {{ redis_tls_cert_file }}
tls-key-file {{ redis_tls_key_file }}
tls-ca-cert-file {{ redis_tls_ca_cert_file }}

# TLS Security
tls-protocols "TLSv1.2 TLSv1.3"
tls-ciphers "ECDHE+AESGCM:ECDHE+CHACHA20:DHE+AESGCM:DHE+CHACHA20:!aNULL:!MD5:!DSS"
tls-ciphersuites "TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256"
{% endif %}

################################# GENERAL #####################################

# Run as a daemon
daemonize yes

# Process ID file
pidfile {{ redis_pidfile | default('/var/run/redis/redis-server.pid') }}

# Log level: debug, verbose, notice, warning
loglevel {{ redis_loglevel | default('notice') }}

# Log file
logfile {{ redis_logfile | default('/var/log/redis/redis-server.log') }}

# Number of databases
databases {{ redis_databases | default(16) }}

################################ SNAPSHOTTING  ################################

# Save the DB on disk
{% for save_rule in redis_save_rules | default(['3600 1', '300 100', '60 10000']) %}
save {{ save_rule }}
{% endfor %}

# Stop writes on BGSAVE errors
stop-writes-on-bgsave-error {{ redis_stop_writes_on_bgsave_error | default('yes') }}

# Compress string objects using LZF when dump .rdb databases
rdbcompression {{ redis_rdbcompression | default('yes') }}

# Checksum the RDB file
rdbchecksum {{ redis_rdbchecksum | default('yes') }}

# RDB filename
dbfilename {{ redis_dbfilename | default('dump.rdb') }}

# RDB and AOF files directory
dir {{ redis_dir | default('/var/lib/redis') }}

################################# REPLICATION #################################

{% if redis_slaveof_ip is defined and redis_slaveof_port is defined %}
# Master-slave replication
replicaof {{ redis_slaveof_ip }} {{ redis_slaveof_port }}

# Master authentication
{% if redis_masterauth is defined %}
masterauth {{ redis_masterauth }}
{% endif %}

# Replica serve stale data when link is down
replica-serve-stale-data {{ redis_replica_serve_stale_data | default('yes') }}

# Replica read-only
replica-read-only {{ redis_replica_read_only | default('yes') }}
{% endif %}

################################## SECURITY ###################################

# Authentication
{% if redis_auth_enabled | default(true) %}
# Load ACL users from file
aclfile {{ redis_aclfile | default('/etc/redis/users.acl') }}

# Default password (disabled by ACL)
# requirepass {{ redis_password | default('changeme') }}
{% endif %}

# Disable dangerous commands
{% for cmd in redis_disabled_commands | default(['FLUSHDB', 'FLUSHALL', 'KEYS', 'PEXPIRE', 'DEL', 'CONFIG', 'SHUTDOWN', 'EVAL']) %}
rename-command {{ cmd }} ""
{% endfor %}

################################### CLIENTS ####################################

# Max number of clients
maxclients {{ redis_maxclients | default(10000) }}

############################## MEMORY MANAGEMENT #############################

# Memory limit
{% if redis_maxmemory is defined %}
maxmemory {{ redis_maxmemory }}
{% endif %}

# Memory eviction policy
maxmemory-policy {{ redis_maxmemory_policy | default('allkeys-lru') }}

# Memory sampling
maxmemory-samples {{ redis_maxmemory_samples | default(5) }}

############################# LAZY FREEING ####################################

# Lazy freeing
lazyfree-lazy-eviction {{ redis_lazyfree_lazy_eviction | default('no') }}
lazyfree-lazy-expire {{ redis_lazyfree_lazy_expire | default('no') }}
lazyfree-lazy-server-del {{ redis_lazyfree_lazy_server_del | default('no') }}
replica-lazy-flush {{ redis_replica_lazy_flush | default('no') }}

############################ KERNEL OOM CONTROL ##############################

# OOM Score adjustment
oom-score-adj {{ redis_oom_score_adj | default('no') }}

#################### KERNEL TRANSPARENT HUGEPAGE CONTROL ######################

# Disable THP
disable-thp {{ redis_disable_thp | default('yes') }}

############################## APPEND ONLY FILE ###############################

# Enable AOF
appendonly {{ redis_appendonly | default('yes') }}

# AOF filename
appendfilename {{ redis_appendfilename | default('appendonly.aof') }}

# AOF sync policy
appendfsync {{ redis_appendfsync | default('everysec') }}

# Don't fsync when rewriting AOF
no-appendfsync-on-rewrite {{ redis_no_appendfsync_on_rewrite | default('no') }}

# AOF rewrite percentage
auto-aof-rewrite-percentage {{ redis_auto_aof_rewrite_percentage | default(100) }}

# AOF rewrite min size
auto-aof-rewrite-min-size {{ redis_auto_aof_rewrite_min_size | default('64mb') }}

# Handle truncated AOF files
aof-load-truncated {{ redis_aof_load_truncated | default('yes') }}

# Use RDB-AOF hybrid format
aof-use-rdb-preamble {{ redis_aof_use_rdb_preamble | default('yes') }}

################################ LUA SCRIPTING  ###############################

# Lua time limit
lua-time-limit {{ redis_lua_time_limit | default(5000) }}

################################## SLOW LOG ###################################

# Slow log configuration
slowlog-log-slower-than {{ redis_slowlog_log_slower_than | default(10000) }}
slowlog-max-len {{ redis_slowlog_max_len | default(128) }}

################################ LATENCY MONITOR ##############################

# Latency monitoring
latency-monitor-threshold {{ redis_latency_monitor_threshold | default(100) }}

############################# EVENT NOTIFICATION ##############################

# Keyspace notifications
{% if redis_notify_keyspace_events is defined %}
notify-keyspace-events {{ redis_notify_keyspace_events }}
{% endif %}

############################### ADVANCED CONFIG ###############################

# Hash settings
hash-max-ziplist-entries {{ redis_hash_max_ziplist_entries | default(512) }}
hash-max-ziplist-value {{ redis_hash_max_ziplist_value | default(64) }}

# List settings
list-max-ziplist-size {{ redis_list_max_ziplist_size | default(-2) }}
list-compress-depth {{ redis_list_compress_depth | default(0) }}

# Set settings
set-max-intset-entries {{ redis_set_max_intset_entries | default(512) }}

# Sorted set settings
zset-max-ziplist-entries {{ redis_zset_max_ziplist_entries | default(128) }}
zset-max-ziplist-value {{ redis_zset_max_ziplist_value | default(64) }}

# HyperLogLog settings
hll-sparse-max-bytes {{ redis_hll_sparse_max_bytes | default(3000) }}

# Streams settings
stream-node-max-bytes {{ redis_stream_node_max_bytes | default(4096) }}
stream-node-max-entries {{ redis_stream_node_max_entries | default(100) }}

# Active rehashing
activerehashing {{ redis_activerehashing | default('yes') }}

# Client output buffer limits
client-output-buffer-limit normal {{ redis_client_output_buffer_limit_normal | default('0 0 0') }}
client-output-buffer-limit replica {{ redis_client_output_buffer_limit_replica | default('256mb 64mb 60') }}
client-output-buffer-limit pubsub {{ redis_client_output_buffer_limit_pubsub | default('32mb 8mb 60') }}

# Client query buffer limit
client-query-buffer-limit {{ redis_client_query_buffer_limit | default('1gb') }}

# Protocol buffer limit
proto-max-bulk-len {{ redis_proto_max_bulk_len | default('512mb') }}

# Frequency of rehashing
hz {{ redis_hz | default(10) }}

# Enable dynamic HZ
dynamic-hz {{ redis_dynamic_hz | default('yes') }}

# AOF rewrite incremental fsync
aof-rewrite-incremental-fsync {{ redis_aof_rewrite_incremental_fsync | default('yes') }}

# RDB save incremental fsync
rdb-save-incremental-fsync {{ redis_rdb_save_incremental_fsync | default('yes') }}

# JEMalloc background thread
jemalloc-bg-thread {{ redis_jemalloc_bg_thread | default('yes') }}

################################## MODULES #####################################

{% if redis_modules is defined %}
# Load Redis modules
{% for module in redis_modules %}
loadmodule {{ module }}
{% endfor %}
{% endif %}

################################## INCLUDES ####################################

# Include other config files if present
{% if redis_include_files is defined %}
{% for include_file in redis_include_files %}
include {{ include_file }}
{% endfor %}
{% endif %}