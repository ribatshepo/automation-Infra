# Redis Stack Configuration File
# Generated by Ansible - {{ ansible_date_time.iso8601 }}

################################## NETWORK #####################################

# Bind to specific network interfaces
bind {{ redis_stack_bind_address | default('127.0.0.1') }}

# Accept connections on the specified port
port {{ redis_stack_port | default(6379) }}

# TCP listen() backlog
tcp-backlog {{ redis_stack_tcp_backlog | default(511) }}

# TCP keepalive
tcp-keepalive {{ redis_stack_tcp_keepalive | default(300) }}

# Timeout for idle clients (0 = never timeout)
timeout {{ redis_stack_timeout | default(0) }}

################################# TLS/SSL ######################################

# Enable TLS/SSL support
{% if redis_stack_tls_enabled | default(false) %}
tls-port {{ redis_stack_tls_port | default(6380) }}
port 0

# Configure certificates
tls-cert-file {{ redis_stack_tls_cert_file }}
tls-key-file {{ redis_stack_tls_key_file }}
tls-ca-cert-file {{ redis_stack_tls_ca_cert_file }}

# TLS Security
tls-protocols "TLSv1.2 TLSv1.3"
tls-ciphers "ECDHE+AESGCM:ECDHE+CHACHA20:DHE+AESGCM:DHE+CHACHA20:!aNULL:!MD5:!DSS"
tls-ciphersuites "TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256"
{% endif %}

################################# GENERAL #####################################

# Run as a daemon
daemonize yes

# Process ID file
pidfile {{ redis_stack_pidfile | default('/var/run/redis-stack/redis-stack-server.pid') }}

# Log level: debug, verbose, notice, warning
loglevel {{ redis_stack_loglevel | default('notice') }}

# Log file
logfile {{ redis_stack_logfile | default('/var/log/redis-stack/redis-stack-server.log') }}

# Number of databases
databases {{ redis_stack_databases | default(16) }}

################################ SNAPSHOTTING  ################################

# Save the DB on disk
{% for save_rule in redis_stack_save_rules | default(['3600 1', '300 100', '60 10000']) %}
save {{ save_rule }}
{% endfor %}

# Stop writes on BGSAVE errors
stop-writes-on-bgsave-error {{ redis_stack_stop_writes_on_bgsave_error | default('yes') }}

# Compress string objects using LZF when dump .rdb databases
rdbcompression {{ redis_stack_rdbcompression | default('yes') }}

# Checksum the RDB file
rdbchecksum {{ redis_stack_rdbchecksum | default('yes') }}

# RDB filename
dbfilename {{ redis_stack_dbfilename | default('dump.rdb') }}

# RDB and AOF files directory
dir {{ redis_stack_dir | default('/var/lib/redis-stack') }}

################################# REPLICATION #################################

{% if redis_stack_slaveof_ip is defined and redis_stack_slaveof_port is defined %}
# Master-slave replication
replicaof {{ redis_stack_slaveof_ip }} {{ redis_stack_slaveof_port }}

# Master authentication
{% if redis_stack_masterauth is defined %}
masterauth {{ redis_stack_masterauth }}
{% endif %}

# Replica serve stale data when link is down
replica-serve-stale-data {{ redis_stack_replica_serve_stale_data | default('yes') }}

# Replica read-only
replica-read-only {{ redis_stack_replica_read_only | default('yes') }}
{% endif %}

################################## SECURITY ###################################

# Authentication
{% if redis_stack_auth_enabled | default(true) %}
# Load ACL users from file
aclfile {{ redis_stack_aclfile | default('/etc/redis-stack/users.acl') }}

# Default password (disabled by ACL)
# requirepass {{ redis_stack_password | default('changeme') }}
{% endif %}

# Disable dangerous commands
{% for cmd in redis_stack_disabled_commands | default(['FLUSHDB', 'FLUSHALL', 'KEYS', 'PEXPIRE', 'DEL', 'CONFIG', 'SHUTDOWN', 'EVAL']) %}
rename-command {{ cmd }} ""
{% endfor %}

################################### CLIENTS ####################################

# Max number of clients
maxclients {{ redis_stack_maxclients | default(10000) }}

############################## MEMORY MANAGEMENT #############################

# Memory limit
{% if redis_stack_maxmemory is defined %}
maxmemory {{ redis_stack_maxmemory }}
{% endif %}

# Memory eviction policy
maxmemory-policy {{ redis_stack_maxmemory_policy | default('allkeys-lru') }}

# Memory sampling
maxmemory-samples {{ redis_stack_maxmemory_samples | default(5) }}

############################# LAZY FREEING ####################################

# Lazy freeing
lazyfree-lazy-eviction {{ redis_stack_lazyfree_lazy_eviction | default('no') }}
lazyfree-lazy-expire {{ redis_stack_lazyfree_lazy_expire | default('no') }}
lazyfree-lazy-server-del {{ redis_stack_lazyfree_lazy_server_del | default('no') }}
replica-lazy-flush {{ redis_stack_replica_lazy_flush | default('no') }}

############################ KERNEL OOM CONTROL ##############################

# OOM Score adjustment
oom-score-adj {{ redis_stack_oom_score_adj | default('no') }}

#################### KERNEL TRANSPARENT HUGEPAGE CONTROL ######################

# Disable THP
disable-thp {{ redis_stack_disable_thp | default('yes') }}

############################## APPEND ONLY FILE ###############################

# Enable AOF
appendonly {{ redis_stack_appendonly | default('yes') }}

# AOF filename
appendfilename {{ redis_stack_appendfilename | default('appendonly.aof') }}

# AOF sync policy
appendfsync {{ redis_stack_appendfsync | default('everysec') }}

# Don't fsync when rewriting AOF
no-appendfsync-on-rewrite {{ redis_stack_no_appendfsync_on_rewrite | default('no') }}

# AOF rewrite percentage
auto-aof-rewrite-percentage {{ redis_stack_auto_aof_rewrite_percentage | default(100) }}

# AOF rewrite min size
auto-aof-rewrite-min-size {{ redis_stack_auto_aof_rewrite_min_size | default('64mb') }}

# Handle truncated AOF files
aof-load-truncated {{ redis_stack_aof_load_truncated | default('yes') }}

# Use RDB-AOF hybrid format
aof-use-rdb-preamble {{ redis_stack_aof_use_rdb_preamble | default('yes') }}

################################ LUA SCRIPTING  ###############################

# Lua time limit
lua-time-limit {{ redis_stack_lua_time_limit | default(5000) }}

################################## SLOW LOG ###################################

# Slow log configuration
slowlog-log-slower-than {{ redis_stack_slowlog_log_slower_than | default(10000) }}
slowlog-max-len {{ redis_stack_slowlog_max_len | default(128) }}

################################ LATENCY MONITOR ##############################

# Latency monitoring
latency-monitor-threshold {{ redis_stack_latency_monitor_threshold | default(100) }}

############################# EVENT NOTIFICATION ##############################

# Keyspace notifications
{% if redis_stack_notify_keyspace_events is defined %}
notify-keyspace-events {{ redis_stack_notify_keyspace_events }}
{% endif %}

############################### ADVANCED CONFIG ###############################

# Hash settings
hash-max-ziplist-entries {{ redis_stack_hash_max_ziplist_entries | default(512) }}
hash-max-ziplist-value {{ redis_stack_hash_max_ziplist_value | default(64) }}

# List settings
list-max-ziplist-size {{ redis_stack_list_max_ziplist_size | default(-2) }}
list-compress-depth {{ redis_stack_list_compress_depth | default(0) }}

# Set settings
set-max-intset-entries {{ redis_stack_set_max_intset_entries | default(512) }}

# Sorted set settings
zset-max-ziplist-entries {{ redis_stack_zset_max_ziplist_entries | default(128) }}
zset-max-ziplist-value {{ redis_stack_zset_max_ziplist_value | default(64) }}

# HyperLogLog settings
hll-sparse-max-bytes {{ redis_stack_hll_sparse_max_bytes | default(3000) }}

# Streams settings
stream-node-max-bytes {{ redis_stack_stream_node_max_bytes | default(4096) }}
stream-node-max-entries {{ redis_stack_stream_node_max_entries | default(100) }}

# Active rehashing
activerehashing {{ redis_stack_activerehashing | default('yes') }}

# Client output buffer limits
client-output-buffer-limit normal {{ redis_stack_client_output_buffer_limit_normal | default('0 0 0') }}
client-output-buffer-limit replica {{ redis_stack_client_output_buffer_limit_replica | default('256mb 64mb 60') }}
client-output-buffer-limit pubsub {{ redis_stack_client_output_buffer_limit_pubsub | default('32mb 8mb 60') }}

# Client query buffer limit
client-query-buffer-limit {{ redis_stack_client_query_buffer_limit | default('1gb') }}

# Protocol buffer limit
proto-max-bulk-len {{ redis_stack_proto_max_bulk_len | default('512mb') }}

# Frequency of rehashing
hz {{ redis_stack_hz | default(10) }}

# Enable dynamic HZ
dynamic-hz {{ redis_stack_dynamic_hz | default('yes') }}

# AOF rewrite incremental fsync
aof-rewrite-incremental-fsync {{ redis_stack_aof_rewrite_incremental_fsync | default('yes') }}

# RDB save incremental fsync
rdb-save-incremental-fsync {{ redis_stack_rdb_save_incremental_fsync | default('yes') }}

# JEMalloc background thread
jemalloc-bg-thread {{ redis_stack_jemalloc_bg_thread | default('yes') }}

################################## MODULES #####################################

# Redis Stack Modules (automatically loaded by Redis Stack)
# The following modules are included with Redis Stack:
# - RedisJSON (JSON data type support)
# - RediSearch (Full-text search and secondary indexing)
# - RedisGraph (Graph database capabilities) 
# - RedisTimeSeries (Time series data support)
# - RedisBloom (Probabilistic data structures)

{% if redis_stack_modules is defined %}
# Load additional Redis modules
{% for module in redis_stack_modules %}
loadmodule {{ module }}
{% endfor %}
{% endif %}

################################# REDISEARCH ###################################

# RediSearch configuration
{% if redis_stack_search_enabled | default(true) %}
# Maximum number of search results returned
{% if redis_stack_search_maxsearchresults is defined %}
REDISEARCH_MAXSEARCHRESULTS {{ redis_stack_search_maxsearchresults }}
{% endif %}

# Maximum prefix expansions
{% if redis_stack_search_maxprefixexpansions is defined %}
REDISEARCH_MAXPREFIXEXPANSIONS {{ redis_stack_search_maxprefixexpansions }}
{% endif %}
{% endif %}

################################# REDISJSON ####################################

# RedisJSON configuration
{% if redis_stack_json_enabled | default(true) %}
# Maximum JSON nesting depth
{% if redis_stack_json_maxdepth is defined %}
REDISJSON_MAXDEPTH {{ redis_stack_json_maxdepth }}
{% endif %}
{% endif %}

################################# REDISTIMESERIES ###########################

# RedisTimeSeries configuration
{% if redis_stack_timeseries_enabled | default(true) %}
# Maximum samples per chunk
{% if redis_stack_ts_maxsamplesperchunk is defined %}
REDISTIMESERIES_MAXSAMPLESPERCHUNK {{ redis_stack_ts_maxsamplesperchunk }}
{% endif %}
{% endif %}

################################## INCLUDES ####################################

# Include other config files if present
{% if redis_stack_include_files is defined %}
{% for include_file in redis_stack_include_files %}
include {{ include_file }}
{% endfor %}
{% endif %}