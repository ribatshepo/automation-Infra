---
- name: Join Worker Nodes to Kubernetes Cluster
  hosts: k8s_workers
  become: yes
  vars_files:
    - ../vars.yml
    - ../vault.yml

  tasks:
    - name: Check if node is already part of cluster
      stat:
        path: /etc/kubernetes/kubelet.conf
      register: node_joined

    - name: Read worker join command from first master
      slurp:
        src: /tmp/join-command-workers
      register: join_command_file
      delegate_to: "{{ groups['k8s_masters'][0] }}"
      when: not node_joined.stat.exists

    - name: Set join command fact
      set_fact:
        worker_join_command: "{{ join_command_file.content | b64decode | trim }}"
      when: not node_joined.stat.exists

    - name: Join worker node to cluster
      shell: "{{ worker_join_command }}"
      register: join_result
      when: not node_joined.stat.exists
      tags:
        - worker
        - join

    - name: Wait for kubelet to be ready
      systemd:
        name: kubelet
        state: started
      tags:
        - worker
        - service

    - name: Verify worker node status from master
      shell: kubectl get nodes {{ inventory_hostname }}
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: node_status
      delegate_to: "{{ groups['k8s_masters'][0] }}"
      retries: 10
      delay: 15
      until: "'Ready' in node_status.stdout"
      tags:
        - worker
        - verify

    - name: Label worker nodes
      shell: |
        kubectl label node {{ inventory_hostname }} node-role.kubernetes.io/worker=worker --overwrite
        kubectl label node {{ inventory_hostname }} kubernetes.io/role=worker --overwrite
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      delegate_to: "{{ groups['k8s_masters'][0] }}"
      tags:
        - worker
        - labels

    - name: Display worker join status
      debug:
        msg: |
          Worker Node Join Complete:
          =========================
          - Node: {{ inventory_hostname }}
          - Status: {{ 'Joined' if not node_joined.stat.exists else 'Already joined' }}
          - Cluster Role: Worker
          
          Node Status: {{ node_status.stdout if node_status is defined else 'Check manually' }}
      tags:
        - worker
        - info