global
    log 127.0.0.1:514 local0 info
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

    # Default SSL material locations
    ca-base /etc/ssl/certs
    crt-base /etc/ssl/private

    # Tune SSL defaults
    ssl-default-bind-ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:RSA+AESGCM:RSA+AES:!aNULL:!MD5:!DSS
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option log-health-checks
    option forwardfor
    option http-server-close
    timeout connect 5000
    timeout client 50000
    timeout server 50000
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

# Frontend for Kubernetes API Server
frontend kubernetes_api_frontend
    bind {{ haproxy_vip }}:{{ haproxy_api_port }}
    mode tcp
    option tcplog
    default_backend kubernetes_api_backend

# Backend for Kubernetes API Servers
backend kubernetes_api_backend
    mode tcp
    balance roundrobin
    option tcp-check
    
    # Health check for Kubernetes API
    tcp-check connect port {{ kubernetes_api_port }}
    tcp-check send-binary 474554202f76657273696f6e20485454502f312e310d0a486f73743a206c6f63616c686f73740d0a0d0a
    tcp-check expect binary 485454502f312e31
    
{% for master in kubernetes_masters %}
    server {{ master.name }} {{ master.ip }}:{{ kubernetes_api_port }} check inter 2000 rise 2 fall 3
{% endfor %}

# Stats interface
listen stats
    bind {{ haproxy_vip }}:{{ haproxy_stats_port }}
    mode http
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE
    stats auth {{ haproxy_stats_user }}:{{ haproxy_stats_password }}
    stats realm "HAProxy Statistics for Kubernetes"

# Frontend for HTTP traffic (future use)
frontend http_frontend
    bind {{ haproxy_vip }}:80
    mode http
    redirect scheme https code 301 if !{ ssl_fc }

# Frontend for HTTPS traffic (future use)
frontend https_frontend
    bind {{ haproxy_vip }}:443 ssl crt /etc/ssl/private/haproxy.pem
    mode http
    option httplog
    
    # Default backend (can be customized later)
    default_backend default_backend

# Default backend for web traffic
backend default_backend
    mode http
    balance roundrobin
    option httpchk GET /healthz
    
    # Placeholder servers (to be configured with Ingress)
{% for worker in kubernetes_workers %}
    server {{ worker.name }} {{ worker.ip }}:80 check inter 2000 rise 2 fall 3 backup
{% endfor %}

# Backend for HTTPS traffic to workers
backend https_backend
    mode http
    balance roundrobin
    option httpchk GET /healthz
    
{% for worker in kubernetes_workers %}
    server {{ worker.name }}-https {{ worker.ip }}:443 check inter 2000 rise 2 fall 3 ssl verify none backup
{% endfor %}