global
    log stdout local0
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

    # Default SSL material locations
    ca-base /etc/ssl/certs
    crt-base /etc/ssl/private

    # Default ciphers to use on SSL-enabled listening sockets
    ssl-default-bind-ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:RSA+AESGCM:RSA+AES:!aNULL:!MD5:!DSS
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option log-health-checks
    option forwardfor
    option httpchk GET /healthz
    timeout connect 10s
    timeout client 86400s
    timeout server 86400s
    timeout tunnel 86400s

frontend kube_api_frontend
    bind {{ ansible_default_ipv4.address }}:6443
    mode tcp
    option tcplog
    default_backend kube_api_backend

backend kube_api_backend
    mode tcp
    balance roundrobin
    option tcp-check
{% for host in groups['k8s_masters'] %}
    server {{ hostvars[host]['inventory_hostname'] }} {{ hostvars[host]['ansible_host'] }}:6443 check inter 10000
{% endfor %}

# Statistics interface
frontend stats
    bind {{ ansible_default_ipv4.address }}:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats hide-version
{% if haproxy_stats_user is defined and haproxy_stats_password is defined %}
    stats auth {{ haproxy_stats_user }}:{{ haproxy_stats_password }}
{% endif %}