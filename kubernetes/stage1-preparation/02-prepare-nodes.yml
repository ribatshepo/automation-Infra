---
- name: Prepare All Kubernetes Nodes (Masters and Workers)
  hosts: k8s_masters:k8s_workers
  become: yes
  vars_files:
    - ../vars.yml
    - ../vault.yml

  tasks:
    - name: Update apt package cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      tags:
        - preparation
        - packages

    - name: Install required system packages
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - software-properties-common
          - wget
          - net-tools
          - socat
          - conntrack
          - ipset
          - iptables
          - arptables
          - ebtables
          - ethtool
          - util-linux
          - mount
          - bash-completion
          - vim
          - htop
        state: present
      tags:
        - preparation
        - packages

    - name: Disable swap
      shell: |
        swapoff -a
        sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab
      when: disable_swap
      tags:
        - preparation
        - swap

    - name: Configure kernel modules
      copy:
        content: |
          br_netfilter
          overlay
          ip_vs
          ip_vs_rr
          ip_vs_wrr
          ip_vs_sh
          nf_conntrack
        dest: /etc/modules-load.d/kubernetes.conf
        mode: '0644'
      tags:
        - preparation
        - kernel

    - name: Load kernel modules
      modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - br_netfilter
        - overlay
        - ip_vs
        - ip_vs_rr
        - ip_vs_wrr
        - ip_vs_sh
        - nf_conntrack
      tags:
        - preparation
        - kernel

    - name: Configure sysctl parameters
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        sysctl_set: true
        reload: true
        sysctl_file: /etc/sysctl.d/kubernetes.conf
      loop:
        - { name: 'net.bridge.bridge-nf-call-iptables', value: '1' }
        - { name: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }
        - { name: 'net.ipv4.ip_forward', value: '1' }
        - { name: 'net.ipv4.conf.all.forwarding', value: '1' }
        - { name: 'net.ipv6.conf.all.forwarding', value: '1' }
        - { name: 'vm.swappiness', value: '0' }
        - { name: 'vm.overcommit_memory', value: '1' }
        - { name: 'vm.panic_on_oom', value: '0' }
        - { name: 'fs.inotify.max_user_watches', value: '1048576' }
        - { name: 'fs.inotify.max_user_instances', value: '8192' }
        - { name: 'fs.file-max', value: '2097152' }
        - { name: 'net.netfilter.nf_conntrack_max', value: '1000000' }
        - { name: 'net.core.somaxconn', value: '32768' }
        - { name: 'net.ipv4.tcp_max_syn_backlog', value: '8096' }
        - { name: 'net.core.netdev_max_backlog', value: '16384' }
      tags:
        - preparation
        - sysctl

    - name: Set system limits for Kubernetes
      copy:
        content: |
          * soft nofile {{ node_max_open_files }}
          * hard nofile {{ node_max_open_files }}
          * soft nproc {{ node_max_processes }}
          * hard nproc {{ node_max_processes }}
          root soft nofile {{ node_max_open_files }}
          root hard nofile {{ node_max_open_files }}
          root soft nproc {{ node_max_processes }}
          root hard nproc {{ node_max_processes }}
        dest: /etc/security/limits.d/kubernetes.conf
        mode: '0644'
      tags:
        - preparation
        - limits

    - name: Configure DNS resolution
      lineinfile:
        path: /etc/hosts
        line: "{{ item.ip }}    {{ item.hostname }}"
        regexp: "^{{ item.ip }}.*{{ item.hostname }}"
        state: present
      loop: "{{ kubernetes_masters + kubernetes_workers + [{'ip': haproxy_vip, 'hostname': 'k8s-api'}] }}"
      tags:
        - preparation
        - dns

    - name: Add Kubernetes APT repository key
      apt_key:
        url: "https://pkgs.k8s.io/core:/stable:/v1.29/deb/Release.key"
        keyring: /etc/apt/keyrings/kubernetes-apt-keyring.gpg
        state: present
      tags:
        - preparation
        - repository

    - name: Add Kubernetes APT repository
      apt_repository:
        repo: "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] {{ kubernetes_apt_repo }} /"
        state: present
        filename: kubernetes
      tags:
        - preparation
        - repository

    - name: Add Docker APT repository key
      apt_key:
        url: "https://download.docker.com/linux/ubuntu/gpg"
        keyring: /etc/apt/keyrings/docker.gpg
        state: present
      tags:
        - preparation
        - repository

    - name: Add Docker APT repository
      apt_repository:
        repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] {{ docker_apt_repo }} {{ ansible_distribution_release }} stable"
        state: present
        filename: docker
      tags:
        - preparation
        - repository

    - name: Update apt cache after adding repositories
      apt:
        update_cache: yes
      tags:
        - preparation
        - packages

    - name: Install containerd
      apt:
        name:
          - containerd.io
        state: present
      tags:
        - preparation
        - containerd

    - name: Create containerd configuration directory
      file:
        path: /etc/containerd
        state: directory
        mode: '0755'
      tags:
        - preparation
        - containerd

    - name: Configure containerd with CRI support
      template:
        src: containerd-config.toml.j2
        dest: /etc/containerd/config.toml
        mode: '0644'
      notify: restart containerd
      tags:
        - preparation
        - containerd

    - name: Enable and start containerd
      systemd:
        name: containerd
        enabled: yes
        state: started
        daemon_reload: yes
      tags:
        - preparation
        - containerd

    - name: Force restart containerd after configuration change
      systemd:
        name: containerd
        state: restarted
      tags:
        - preparation
        - containerd

    - name: Wait for containerd to be ready
      wait_for:
        path: /var/run/containerd/containerd.sock
        delay: 5
        timeout: 30
      tags:
        - preparation
        - containerd

    - name: Verify CRI runtime is working
      command: crictl --runtime-endpoint unix:///var/run/containerd/containerd.sock version
      register: cri_version
      retries: 3
      delay: 5
      until: cri_version.rc == 0
      tags:
        - preparation
        - containerd
        - verification

    - name: Install Kubernetes packages
      apt:
        name:
          - kubelet={{ kubernetes_version }}-*
          - kubeadm={{ kubernetes_version }}-*
          - kubectl={{ kubernetes_version }}-*
        state: present
      tags:
        - preparation
        - kubernetes

    - name: Hold Kubernetes packages to prevent automatic updates
      dpkg_selections:
        name: "{{ item }}"
        selection: hold
      loop:
        - kubelet
        - kubeadm
        - kubectl
      tags:
        - preparation
        - kubernetes

    - name: Create kubelet service drop-in directory
      file:
        path: /etc/systemd/system/kubelet.service.d
        state: directory
        owner: root
        group: root
        mode: '0755'
      tags:
        - preparation
        - kubelet

    - name: Configure kubelet service
      template:
        src: kubelet-extra-args.conf.j2
        dest: /etc/systemd/system/kubelet.service.d/10-kubelet-extra-args.conf
        owner: root
        group: root
        mode: '0644'
      tags:
        - preparation
        - kubelet

    - name: Enable kubelet service
      systemd:
        name: kubelet
        enabled: yes
        daemon_reload: yes
      tags:
        - preparation
        - kubelet

    - name: Configure firewall for Kubernetes nodes
      ufw:
        rule: allow
        port: "{{ item }}"
        src: "10.100.10.0/24"
      loop: "{{ master_ports if inventory_hostname in groups['k8s_masters'] else worker_ports }}"
      when: firewall_enabled
      tags:
        - preparation
        - firewall

    - name: Display node preparation status
      debug:
        msg: |
          Node Preparation Complete for {{ inventory_hostname }}:
          ================================================
          - Role: {{ 'Master' if inventory_hostname in groups['k8s_masters'] else 'Worker' }}
          - IP Address: {{ ansible_default_ipv4.address }}
          - Kubernetes Version: {{ kubernetes_version }}
          - Container Runtime: {{ container_runtime }}
          - Swap Disabled: {{ 'Yes' if disable_swap else 'No' }}
          - Ready for cluster setup!
      tags:
        - preparation
        - info

  handlers:
    - name: restart containerd
      systemd:
        name: containerd
        state: restarted
        daemon_reload: yes

    - name: restart kubelet
      systemd:
        name: kubelet
        state: restarted
        daemon_reload: yes