#!/bin/bash
# Harbor Restore Script
# Generated by Ansible for {{ inventory_hostname }}

set -euo pipefail

# Configuration
HARBOR_DIR="{{ harbor_install_dir }}/harbor"
BACKUP_DIR="{{ harbor_backup_dir | default('/backup/harbor') }}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Logging function
log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')] $1${NC}"
}

error() {
    echo -e "${RED}[$(date +'%Y-%m-%d %H:%M:%S')] ERROR: $1${NC}" >&2
}

warn() {
    echo -e "${YELLOW}[$(date +'%Y-%m-%d %H:%M:%S')] WARNING: $1${NC}"
}

# Usage function
usage() {
    cat << EOF
Harbor Restore Script

Usage: $0 <backup-file>

Arguments:
    backup-file    Path to the Harbor backup file (.tar.gz)

Examples:
    $0 /backup/harbor/harbor-backup-20241101_143000.tar.gz
    $0 harbor-backup-20241101_143000.tar.gz

EOF
}

# Check arguments
if [[ $# -ne 1 ]]; then
    error "Invalid number of arguments"
    usage
    exit 1
fi

BACKUP_FILE="$1"

# Check if backup file exists
if [[ ! -f "$BACKUP_FILE" ]]; then
    # Try in backup directory
    if [[ -f "${BACKUP_DIR}/${BACKUP_FILE}" ]]; then
        BACKUP_FILE="${BACKUP_DIR}/${BACKUP_FILE}"
    else
        error "Backup file not found: $BACKUP_FILE"
        exit 1
    fi
fi

log "Starting Harbor restore from: $BACKUP_FILE"

# Confirmation prompt
read -p "This will replace current Harbor installation. Continue? (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    log "Restore cancelled by user"
    exit 0
fi

# Stop Harbor services
log "Stopping Harbor services..."
systemctl stop harbor || {
    warn "Failed to stop Harbor services (may not be running)"
}

# Backup current installation
log "Creating backup of current installation..."
CURRENT_BACKUP="${HARBOR_DIR}-backup-$(date +%Y%m%d_%H%M%S)"
if [[ -d "$HARBOR_DIR" ]]; then
    mv "$HARBOR_DIR" "$CURRENT_BACKUP"
    log "Current installation backed up to: $CURRENT_BACKUP"
fi

# Create Harbor directory
mkdir -p "$HARBOR_DIR"

# Extract backup
log "Extracting backup archive..."
cd "$HARBOR_DIR"
tar -xzf "$BACKUP_FILE" || {
    error "Failed to extract backup archive"
    # Restore original if exists
    if [[ -d "$CURRENT_BACKUP" ]]; then
        rm -rf "$HARBOR_DIR"
        mv "$CURRENT_BACKUP" "$HARBOR_DIR"
    fi
    exit 1
}

# Restore database if backup exists
DATABASE_BACKUP="${BACKUP_FILE%-*.tar.gz}-database.sql"
if [[ -f "$DATABASE_BACKUP" ]] && [[ "{{ harbor_external_database }}" == "true" ]]; then
    log "Restoring database..."
    PGPASSWORD="{{ harbor_db_password }}" psql \
        -h {{ harbor_db_host }} \
        -p {{ harbor_db_port }} \
        -U {{ harbor_db_username }} \
        -d {{ harbor_db_name }} \
        -f "$DATABASE_BACKUP" || {
        warn "Database restore failed"
    }
fi

# Set correct permissions
log "Setting file permissions..."
chown -R root:root "$HARBOR_DIR"
find "$HARBOR_DIR" -type f -name "*.sh" -exec chmod +x {} \;

# Start Harbor services
log "Starting Harbor services..."
systemctl start harbor || {
    error "Failed to start Harbor services"
    exit 1
}

# Wait for Harbor to be ready
log "Waiting for Harbor to be ready..."
TIMEOUT=300
COUNTER=0
while [[ $COUNTER -lt $TIMEOUT ]]; do
    if curl -s -k {{ harbor_base_url }}/api/v2.0/systeminfo > /dev/null 2>&1; then
        break
    fi
    sleep 5
    COUNTER=$((COUNTER + 5))
done

if [[ $COUNTER -ge $TIMEOUT ]]; then
    error "Harbor failed to start within timeout period"
    exit 1
fi

log "Harbor restore completed successfully"
log "Harbor is accessible at: {{ harbor_base_url }}"

# Clean up old current backup after successful restore
if [[ -d "$CURRENT_BACKUP" ]]; then
    read -p "Remove backup of previous installation? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        rm -rf "$CURRENT_BACKUP"
        log "Previous installation backup removed"
    else
        log "Previous installation backup kept at: $CURRENT_BACKUP"
    fi
fi