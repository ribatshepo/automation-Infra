#!/bin/bash
# JFrog Artifactory Admin Password Management Script

# Configuration
ARTIFACTORY_URL="http://localhost:{{ artifactory_port }}{{ artifactory_context_path }}"
ADMIN_USER="{{ artifactory_admin_username }}"
ADMIN_PASS="{{ artifactory_admin_password }}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Functions
show_usage() {
    echo "JFrog Artifactory Admin Password Management"
    echo ""
    echo "Usage: $0 [OPTION]"
    echo ""
    echo "Options:"
    echo "  -s, --show      Show current admin credentials"
    echo "  -c, --change    Change admin password"
    echo "  -t, --test      Test admin login"
    echo "  -h, --help      Show this help message"
    echo ""
}

show_credentials() {
    echo -e "${BLUE}JFrog Artifactory Admin Credentials:${NC}"
    echo -e "URL: ${GREEN}$ARTIFACTORY_URL${NC}"
    echo -e "Username: ${GREEN}$ADMIN_USER${NC}"
    echo -e "Password: ${GREEN}$ADMIN_PASS${NC}"
    echo ""
}

test_login() {
    echo "Testing admin login..."
    
    response=$(curl -s -u "$ADMIN_USER:$ADMIN_PASS" \
        "$ARTIFACTORY_URL/api/system/ping" \
        -w "%{http_code}")
    
    http_code="${response: -3}"
    
    if [ "$http_code" = "200" ]; then
        echo -e "${GREEN}✓ Login successful!${NC}"
        return 0
    else
        echo -e "${RED}✗ Login failed (HTTP $http_code)${NC}"
        return 1
    fi
}

change_password() {
    echo "Changing admin password..."
    
    read -s -p "Enter new password: " new_password
    echo ""
    read -s -p "Confirm new password: " confirm_password
    echo ""
    
    if [ "$new_password" != "$confirm_password" ]; then
        echo -e "${RED}✗ Passwords do not match!${NC}"
        return 1
    fi
    
    {% raw %}if [ ${#new_password} -lt 8 ]; then{% endraw %}
        echo -e "${RED}✗ Password must be at least 8 characters long!${NC}"
        return 1
    fi
    
    # Update password via API
    response=$(curl -s -u "$ADMIN_USER:$ADMIN_PASS" \
        -X PUT "$ARTIFACTORY_URL/api/security/users/$ADMIN_USER" \
        -H "Content-Type: application/json" \
        -d "{\"password\": \"$new_password\"}" \
        -w "%{http_code}")
    
    http_code="${response: -3}"
    
    if [ "$http_code" = "200" ]; then
        echo -e "${GREEN}✓ Password changed successfully!${NC}"
        echo -e "${BLUE}Please update your configuration files with the new password.${NC}"
        return 0
    else
        echo -e "${RED}✗ Password change failed (HTTP $http_code)${NC}"
        return 1
    fi
}

get_system_info() {
    echo "Artifactory System Information:"
    curl -s -u "$ADMIN_USER:$ADMIN_PASS" \
        "$ARTIFACTORY_URL/api/system/version" | \
        python3 -m json.tool 2>/dev/null || echo "Unable to retrieve system info"
}

# Main logic
case "$1" in
    -s|--show)
        show_credentials
        ;;
    -c|--change)
        change_password
        ;;
    -t|--test)
        test_login
        ;;
    -i|--info)
        get_system_info
        ;;
    -h|--help|*)
        show_usage
        ;;
esac